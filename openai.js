// openai.js - –ú–æ—â–Ω—ã–π –æ–±—É—á–∞–µ–º—ã–π –ø–∞—Ä—Å–µ—Ä –¥–ª—è –∏–ø–æ—Ç–µ—á–Ω–æ–≥–æ —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏—è

// –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –¥–ª—è –ø–∞—Ä—Å–µ—Ä–∞
let aiSettings = {
  learningMode: true, // –†–µ–∂–∏–º –æ–±—É—á–µ–Ω–∏—è –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è —Ä–∞—Å–ø–æ–∑–Ω–∞–≤–∞–Ω–∏—è
  learnedPatterns: {}, // –û–±—É—á–µ–Ω–Ω—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
  responseHistory: [] // –ò—Å—Ç–æ—Ä–∏—è –æ—Ç–≤–µ—Ç–æ–≤ –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è
};

// –û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è AI - –º–æ—â–Ω—ã–π –ª–æ–∫–∞–ª—å–Ω—ã–π —Å—É–ø–µ—Ä-–ø–∞—Ä—Å–µ—Ä
async function askGPTNeo(question) {
  // –ò—Å–ø–æ–ª—å–∑—É–µ–º –º–æ—â–Ω—ã–π –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–∞—Ä—Å–µ—Ä —Å –æ–±—É—á–µ–Ω–∏–µ–º
  return generateSuperSmartResponse(question);
}

// –ú–æ—â–Ω—ã–π –æ–±—É—á–∞–µ–º—ã–π –∞—Å—Å–∏—Å—Ç–µ–Ω—Ç –¥–ª—è –∏–ø–æ—Ç–µ—á–Ω–æ–≥–æ —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏—è
async function chatWithGrok(message, conversationHistory = []) {
  const lowerMessage = message.toLowerCase().trim();

  // 1. –°–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ–º—Å—è –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –∫–∞–∫ –∑–∞–ø—Ä–æ—Å –Ω–∞ —Ä–∞—Å—á–µ—Ç
  const calculationResult = tryCalculateFromText(message);
  if (calculationResult.isCalculation) {
    const response = calculationResult.result;
    // –û–±—É—á–∞–µ–º—Å—è –æ—Ç —É—Å–ø–µ—à–Ω—ã—Ö —Ä–∞—Å—á–µ—Ç–æ–≤
    if (aiSettings.learningMode) {
      learnFromInteraction(message, response);
    }
    return {
      message: response,
      conversationHistory: [
        ...conversationHistory,
        { role: "user", content: message },
        { role: "assistant", content: response }
      ]
    };
  }

  // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å—Ç–∞—Ä—É—é –±–∞–∑—É FAQ –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏
  const faqResult = checkFAQ(lowerMessage);
  if (faqResult) {
    if (aiSettings.learningMode) {
      learnFromInteraction(message, faqResult);
    }
    return {
      message: faqResult,
      conversationHistory: [
        ...conversationHistory,
        { role: "user", content: message },
        { role: "assistant", content: faqResult }
      ]
    };
  }

  // 3. –ò—Å–ø–æ–ª—å–∑—É–µ–º —Å—É–ø–µ—Ä-—É–º–Ω—ã–π –ø–∞—Ä—Å–µ—Ä —Å –∞–Ω–∞–ª–∏–∑–æ–º
  const smartResponse = generateSuperSmartResponse(message);
  if (smartResponse && !smartResponse.includes('–Ø –ø–æ—Å—Ç–∞—Ä–∞–ª—Å—è –ø–æ–Ω—è—Ç—å')) {
    if (aiSettings.learningMode) {
      learnFromInteraction(message, smartResponse);
    }
    return {
      message: smartResponse,
      conversationHistory: [
        ...conversationHistory,
        { role: "user", content: message },
        { role: "assistant", content: smartResponse }
      ]
    };
  }

  // 4. –§–∏–Ω–∞–ª—å–Ω—ã–π fallback —Å –æ–±—É—á–µ–Ω–∏–µ–º
  const finalResponse = generateSmartFallback(message, analyzeQuestion(message));
  if (aiSettings.learningMode) {
    learnFromInteraction(message, finalResponse);
  }
  return {
    message: finalResponse,
    conversationHistory: [
      ...conversationHistory,
      { role: "user", content: message },
      { role: "assistant", content: finalResponse }
    ]
  };
}

// –§—É–Ω–∫—Ü–∏—è –æ–±—É—á–µ–Ω–∏—è –æ—Ç –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–π —Å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º
function learnFromInteraction(question, response) {
  const questionKey = question.toLowerCase().trim();

  // –°–æ—Ö—Ä–∞–Ω—è–µ–º –ø–∞—Ç—Ç–µ—Ä–Ω—ã –¥–ª—è –±—É–¥—É—â–∏—Ö —É–ª—É—á—à–µ–Ω–∏–π
  if (!aiSettings.learnedPatterns[questionKey]) {
    aiSettings.learnedPatterns[questionKey] = {
      response: response,
      timestamp: Date.now(),
      usage: 1
    };
  } else {
    aiSettings.learnedPatterns[questionKey].usage++;
  }

  // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º —Ä–∞–∑–º–µ—Ä –±–∞–∑—ã –æ–±—É—á–µ–Ω–∏—è
  if (Object.keys(aiSettings.learnedPatterns).length > 100) {
    // –£–¥–∞–ª—è–µ–º —Å–∞–º—ã–µ —Å—Ç–∞—Ä—ã–µ –ø–∞—Ç—Ç–µ—Ä–Ω—ã
    const sorted = Object.entries(aiSettings.learnedPatterns)
      .sort((a, b) => a[1].timestamp - b[1].timestamp);
    delete aiSettings.learnedPatterns[sorted[0][0]];
  }
}

// –õ–æ–∫–∞–ª—å–Ω–∞—è –ø–æ–ø—ã—Ç–∫–∞ —Ä–∞—Å—á–µ—Ç–∞
function tryCalculateLocally(text) {
  try {
    // –ü—Ä–æ—Å—Ç–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Ä–∞—Å—á–µ—Ç–∞
    const hasBank = /\b(—Å–±–µ—Ä|–≤—Ç–±|–¥–æ–º\.—Ä—Ñ|–∞–ª—å—Ñ–∞|—Ç–∏–º–µ—Ä|–º–µ—Ç–∞–ª–ª|—Ä–æ—Å–±–∞–Ω–∫|—Ä–∞–π—Ñ—Ñ|–ø—Å–±|–∞–∫ –±–∞—Ä—Å|–∑–µ–Ω–∏—Ç|–∏—Ç–±|—É—Ä–∞–ª—Å–∏–±|—é–Ω–∏–∫—Ä–µ–¥–∏—Ç)\b/i.test(text);
    const hasAmount = /\b(\d[\d\s.,]{3,})\b/.test(text);
    const hasRisk = /\b(–∂–∏–∑–Ω—å|–∏–º—É—â–µ—Å—Ç–≤|—Ç–∏—Ç—É–ª)\b/i.test(text);

    if (hasBank && hasAmount && hasRisk) {
      return `üìä **–î–ª—è —Ç–æ—á–Ω–æ–≥–æ —Ä–∞—Å—á–µ—Ç–∞ –Ω—É–∂–Ω—ã –ø–æ–ª–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ:**

‚Ä¢ –ù–∞–∑–≤–∞–Ω–∏–µ –±–∞–Ω–∫–∞ (–°–±–µ—Ä–±–∞–Ω–∫, –í–¢–ë, –î–æ–º.–†–§ –∏ —Ç.–¥.)
‚Ä¢ –û–°–ó (–æ—Å—Ç–∞—Ç–æ–∫ —Å—Å—É–¥–Ω–æ–π –∑–∞–¥–æ–ª–∂–µ–Ω–Ω–æ—Å—Ç–∏)
‚Ä¢ –î–∞—Ç–∞ —Ä–æ–∂–¥–µ–Ω–∏—è –∏ –ø–æ–ª –∑–∞–µ–º—â–∏–∫–∞
‚Ä¢ –¢–∏–ø –æ–±—ä–µ–∫—Ç–∞ (–∫–≤–∞—Ä—Ç–∏—Ä–∞/–¥–æ–º)

**–ü—Ä–∏–º–µ—Ä:** "–°–±–µ—Ä–±–∞–Ω–∫ –æ—Å–∑ 3000000 –º—É–∂ 15.08.1985 –∫–≤–∞—Ä—Ç–∏—Ä–∞"

–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –≤–≤–µ—Å—Ç–∏ –¥–∞–Ω–Ω—ã–µ –≤ —Ç–∞–∫–æ–º —Ñ–æ—Ä–º–∞—Ç–µ!`;
    }

    return null;
  } catch (error) {
    return null;
  }
}

// –°—É–ø–µ—Ä-—É–º–Ω—ã–π –ª–æ–∫–∞–ª—å–Ω—ã–π –ø–∞—Ä—Å–µ—Ä
function generateSuperSmartResponse(question) {
  const q = question.toLowerCase().trim();

  // –†–∞—Å—á–µ—Ç—ã - –ø—Ä–æ–±—É–µ–º –æ–±—Ä–∞–±–æ—Ç–∞—Ç—å –ª–æ–∫–∞–ª—å–Ω–æ
  const calcResult = tryCalculateLocally(question);
  if (calcResult) {
    return calcResult;
  }

  // –£–º–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –Ω–∞ –æ—Å–Ω–æ–≤–µ –∞–Ω–∞–ª–∏–∑–∞
  if (q.includes('—Å–∫–∏–¥–∫') || q.includes('—ç–∫–æ–Ω–æ–º')) {
    return generateDiscountsResponse(analyzeQuestion(question));
  }

  if (q.includes('—Ä–∞–∑–Ω–∏—Ü') || q.includes('—á–µ–º –æ—Ç–ª–∏—á–∞–µ—Ç—Å—è')) {
    return generateComparisonResponse(analyzeQuestion(question));
  }

  if (q.includes('—Å—Ç—Ä–∞—Ö–æ–≤–æ–π —Å–ª—É—á–∞–π') || q.includes('—á—Ç–æ –¥–µ–ª–∞—Ç—å')) {
    return generateEmergencyResponse(analyzeQuestion(question));
  }

  if (q.includes('–ø—Ä–æ–¥–ª') || q.includes('–ø—Ä–æ–¥–ª–µ–Ω–∏–µ')) {
    return generateRenewalResponse(analyzeQuestion(question));
  }

  if (q.includes('–æ–±—É—á–µ–Ω–∏–µ') || q.includes('–æ–±—É—á–∞–µ—Ç—Å—è') || q.includes('—É—á–∏—Ç—Å—è')) {
    return generateLearningResponse();
  }

  if (q.includes('–æ —Å–µ–±–µ') || q.includes('–∫—Ç–æ —Ç—ã') || q.includes('—á—Ç–æ —É–º–µ–µ—à—å')) {
    return generateAboutResponse();
  }

  // –û–±—â–∏–µ –≤–æ–ø—Ä–æ—Å—ã –æ–± –∏–ø–æ—Ç–µ–∫–µ
  if (q.includes('–∏–ø–æ—Ç–µ–∫') || q.includes('–∫—Ä–µ–¥–∏—Ç')) {
    return generateGeneralResponse(analyzeQuestion(question));
  }

  return generateSmartFallback(question, analyzeQuestion(question));
}

// –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–π –∞–Ω–∞–ª–∏–∑–∞—Ç–æ—Ä –≤–æ–ø—Ä–æ—Å–æ–≤
function analyzeQuestion(question) {
  const q = question.toLowerCase();

  const analysis = {
    intent: 'unknown',
    entities: [],
    keywords: [],
    complexity: 'simple'
  };

  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º –Ω–∞–º–µ—Ä–µ–Ω–∏–µ
  if (/\b(—Å–∫–∏–¥–∫|—ç–∫–æ–Ω–æ–º|–¥–µ—à–µ–≤–ª–µ|–≤—ã–≥–æ–¥–Ω)\b/.test(q)) analysis.intent = 'discounts';
  else if (/\b(—Ä–∞–∑–Ω–∏—Ü|–æ—Ç–ª–∏—á–∞|—Å—Ä–∞–≤–Ω–∏|–ø—Ä–æ—Ç–∏–≤|–ª—É—á—à–µ)\b/.test(q)) analysis.intent = 'comparison';
  else if (/\b(—Å–ª—É—á–∞–π|–ø—Ä–æ–∏–∑–æ—à–µ–ª|–ø–æ–≤—Ä–µ–¥–∏–ª|–∑–∞–±–æ–ª–µ–ª|—Å–ª–æ–º–∞–ª)\b/.test(q)) analysis.intent = 'emergency';
  else if (/\b(–ø—Ä–æ–¥–ª|–ø—Ä–æ–¥–ª–µ–Ω–∏–µ|–æ–±–Ω–æ–≤–∏—Ç—å|–ø—Ä–æ–¥–ª–∏—Ç—å)\b/.test(q)) analysis.intent = 'renewal';
  else if (/\b(–∏–ø–æ—Ç–µ–∫|–∫—Ä–µ–¥–∏—Ç|—Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ|–∑–∞—â–∏—Ç)\b/.test(q)) analysis.intent = 'general';

  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å—É—â–Ω–æ—Å—Ç–∏
  if (/\b(—Å–±–µ—Ä|—Å–±–µ—Ä–±–∞–Ω–∫)\b/.test(q)) analysis.entities.push('sberbank');
  if (/\b(–≤—Ç–±)\b/.test(q)) analysis.entities.push('vtb');
  if (/\b(–∂–∏–∑–Ω—å|–∑–¥–æ—Ä–æ–≤—å–µ)\b/.test(q)) analysis.entities.push('life');
  if (/\b(–∏–º—É—â–µ—Å—Ç–≤|–∫–≤–∞—Ä—Ç–∏—Ä|–¥–æ–º)\b/.test(q)) analysis.entities.push('property');

  // –û–ø—Ä–µ–¥–µ–ª—è–µ–º —Å–ª–æ–∂–Ω–æ—Å—Ç—å
  const words = q.split(' ').length;
  if (words > 10) analysis.complexity = 'complex';
  else if (words > 5) analysis.complexity = 'medium';

  return analysis;
}

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –æ—Ç–≤–µ—Ç–æ–≤
function generateDiscountsResponse(analysis) {
  let response = `üí∞ **–°–∫–∏–¥–∫–∏ –Ω–∞ –∏–ø–æ—Ç–µ—á–Ω–æ–µ —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ**\n\n`;

  response += `**–ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–µ —Å–∫–∏–¥–∫–∏ –ø—Ä–µ–¥–æ—Å—Ç–∞–≤–ª—è—é—Ç:**\n`;
  response += `‚Ä¢ **–°–±–µ—Ä–±–∞–Ω–∫:** 25% –Ω–∞ –∂–∏–∑–Ω—å, 10% –Ω–∞ –∏–º—É—â–µ—Å—Ç–≤–æ\n`;
  response += `‚Ä¢ **–í–¢–ë:** 25% –Ω–∞ –∂–∏–∑–Ω—å, 10% –Ω–∞ –∏–º—É—â–µ—Å—Ç–≤–æ\n`;
  response += `‚Ä¢ **–î—Ä—É–≥–∏–µ –±–∞–Ω–∫–∏:** –æ–±—ã—á–Ω–æ 10-15% –Ω–∞ –∫–æ–º–ø–ª–µ–∫—Å\n\n`;

  response += `**–ö–∞–∫ –ø–æ–ª—É—á–∏—Ç—å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—É—é —Å–∫–∏–¥–∫—É:**\n`;
  response += `1. üè¶ –í—ã–±—Ä–∞—Ç—å –±–∞–Ω–∫ —Å–æ —Å–∫–∏–¥–∫–∞–º–∏\n`;
  response += `2. üì¶ –û—Ñ–æ—Ä–º–∏—Ç—å –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ\n`;
  response += `3. ‚è∞ –°–≤–æ–µ–≤—Ä–µ–º–µ–Ω–Ω–∞—è –æ–ø–ª–∞—Ç–∞\n`;
  response += `4. üõ°Ô∏è –ë–µ–∑—É–±—ã—Ç–æ—á–Ω–∞—è –∏—Å—Ç–æ—Ä–∏—è\n\n`;

  response += `**–ü—Ä–∏–º–µ—Ä —ç–∫–æ–Ω–æ–º–∏–∏:**\n`;
  response += `–ë–µ–∑ —Å–∫–∏–¥–æ–∫: 50 000‚ÇΩ\n`;
  response += `–°–æ —Å–∫–∏–¥–∫–∞–º–∏: 37 500‚ÇΩ\n`;
  response += `**–≠–∫–æ–Ω–æ–º–∏—è: 12 500‚ÇΩ (25%)**\n\n`;

  response += `üí° –°–æ–≤–µ—Ç: –°–∫–∏–¥–∫–∏ —Å—É–º–º–∏—Ä—É—é—Ç—Å—è –ø—Ä–∏ –∫–æ–º–ø–ª–µ–∫—Å–Ω–æ–º —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–∏!`;

  return response;
}

function generateComparisonResponse(analysis) {
  let response = `‚öñÔ∏è **–°—Ä–∞–≤–Ω–µ–Ω–∏–µ –≤–∏–¥–æ–≤ –∏–ø–æ—Ç–µ—á–Ω–æ–≥–æ —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏—è**\n\n`;

  if (analysis.entities.includes('life') || analysis.entities.includes('property')) {
    response += `**–°—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –∂–∏–∑–Ω–∏ vs –ò–º—É—â–µ—Å—Ç–≤–∞:**\n\n`;
    response += `üè• **–ñ–∏–∑–Ω—å –∏ –∑–¥–æ—Ä–æ–≤—å–µ:**\n`;
    response += `‚Ä¢ ‚úÖ –û–±—è–∑–∞—Ç–µ–ª—å–Ω–æ –ø–æ –∑–∞–∫–æ–Ω—É\n`;
    response += `‚Ä¢ üíº –ó–∞—â–∏—â–∞–µ—Ç –¥–æ—Ö–æ–¥ –ø—Ä–∏ –±–æ–ª–µ–∑–Ω–∏\n`;
    response += `‚Ä¢ üìà –¢–∞—Ä–∏—Ñ—ã 0.1-2.5% (–ø–æ –≤–æ–∑—Ä–∞—Å—Ç—É)\n`;
    response += `‚Ä¢ üí∞ –°–∫–∏–¥–∫–∏ –¥–æ 25%\n\n`;

    response += `üè† **–ò–º—É—â–µ—Å—Ç–≤–æ:**\n`;
    response += `‚Ä¢ ‚ö†Ô∏è –†–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è –±–∞–Ω–∫–∞–º–∏\n`;
    response += `‚Ä¢ üèóÔ∏è –ó–∞—â–∏—â–∞–µ—Ç –æ—Ç –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–π\n`;
    response += `‚Ä¢ üìä –¢–∞—Ä–∏—Ñ—ã 0.1-0.43% (–ø–æ —Ç–∏–ø—É)\n`;
    response += `‚Ä¢ üí∞ –°–∫–∏–¥–∫–∏ –¥–æ 10%\n\n`;
  }

  response += `**–ö–æ–º–ø–ª–µ–∫—Å–Ω–æ–µ —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –≤—ã–≥–æ–¥–Ω–µ–µ:**\n`;
  response += `‚Ä¢ üì¶ –û–¥–∏–Ω –ø–æ–ª–∏—Å –Ω–∞ –≤—Å–µ —Ä–∏—Å–∫–∏\n`;
  response += `‚Ä¢ üí∏ –≠–∫–æ–Ω–æ–º–∏—è –¥–æ 30%\n`;
  response += `‚Ä¢ üõ°Ô∏è –ú–∞–∫—Å–∏–º–∞–ª—å–Ω–∞—è –∑–∞—â–∏—Ç–∞\n\n`;

  response += `üéØ **–†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏—è:** –í—ã–±–∏—Ä–∞–π—Ç–µ –∫–æ–º–ø–ª–µ–∫—Å - –Ω–∞–¥–µ–∂–Ω–µ–µ –∏ –¥–µ—à–µ–≤–ª–µ!`;

  return response;
}

function generateEmergencyResponse(analysis) {
  let response = `üö® **–î–µ–π—Å—Ç–≤–∏—è –ø—Ä–∏ —Å—Ç—Ä–∞—Ö–æ–≤–æ–º —Å–ª—É—á–∞–µ**\n\n`;

  response += `**–ù–ï–ú–ï–î–õ–ï–ù–ù–û:**\n`;
  response += `1. üìû –ü–æ–∑–≤–æ–Ω–∏—Ç–µ –≤ —Å—Ç—Ä–∞—Ö–æ–≤—É—é –∫–æ–º–ø–∞–Ω–∏—é\n`;
  response += `2. üì∏ –°—Ñ–æ—Ç–æ–≥—Ä–∞—Ñ–∏—Ä—É–π—Ç–µ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏—è\n`;
  response += `3. üõë –ù–µ –ø—Ä–æ–≤–æ–¥–∏—Ç–µ —Ä–µ–º–æ–Ω—Ç\n\n`;

  if (analysis.entities.includes('life')) {
    response += `**–ü—Ä–∏ —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–∏ –∂–∏–∑–Ω–∏:**\n`;
    response += `‚Ä¢ –û–±—Ä–∞—Ç–∏—Ç–µ—Å—å –∫ –ª–µ—á–∞—â–µ–º—É –≤—Ä–∞—á—É\n`;
    response += `‚Ä¢ –ü–æ–ª—É—á–∏—Ç–µ –º–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã\n`;
    response += `‚Ä¢ –°–æ–æ–±—â–∏—Ç–µ –±–∞–Ω–∫—É –æ —Å–∏—Ç—É–∞—Ü–∏–∏\n\n`;
  }

  if (analysis.entities.includes('property')) {
    response += `**–ü—Ä–∏ —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–∏ –∏–º—É—â–µ—Å—Ç–≤–∞:**\n`;
    response += `‚Ä¢ –í—ã–∑–æ–≤–∏—Ç–µ –∞–≤–∞—Ä–∏–π–Ω—É—é —Å–ª—É–∂–±—É\n`;
    response += `‚Ä¢ –û–±–µ—Å–ø–µ—á—å—Ç–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å\n`;
    response += `‚Ä¢ –ó–∞—Ñ–∏–∫—Å–∏—Ä—É–π—Ç–µ —Ñ–∞–∫—Ç –ø—Ä–æ–∏—Å—à–µ—Å—Ç–≤–∏—è\n\n`;
  }

  response += `**–î–æ–∫—É–º–µ–Ω—Ç—ã –¥–ª—è –≤—ã–ø–ª–∞—Ç—ã:**\n`;
  response += `‚Ä¢ –ó–∞—è–≤–ª–µ–Ω–∏–µ –≤ —Å—Ç—Ä–∞—Ö–æ–≤—É—é\n`;
  response += `‚Ä¢ –î–æ–∫—É–º–µ–Ω—Ç—ã, –ø–æ–¥—Ç–≤–µ—Ä–∂–¥–∞—é—â–∏–µ —Ñ–∞–∫—Ç\n`;
  response += `‚Ä¢ –ê–∫—Ç –æ—Å–º–æ—Ç—Ä–∞ –ø–æ–≤—Ä–µ–∂–¥–µ–Ω–∏–π\n\n`;

  response += `‚è±Ô∏è **–°—Ä–æ–∫–∏:** 20-30 –¥–Ω–µ–π –Ω–∞ —Ä–∞—Å—Å–º–æ—Ç—Ä–µ–Ω–∏–µ\n\n`;
  response += `üí° **–í–∞–∂–Ω–æ:** –ë–∞–Ω–∫ –ø–æ–ª—É—á–∏—Ç –≤—ã–ø–ª–∞—Ç—É –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏!`;

  return response;
}

function generateRenewalResponse(analysis) {
  let response = `üîÑ **–ü—Ä–æ–¥–ª–µ–Ω–∏–µ –∏–ø–æ—Ç–µ—á–Ω–æ–≥–æ —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏—è**\n\n`;

  response += `**–ö–æ–≥–¥–∞ –ø—Ä–æ–¥–ª–µ–≤–∞—Ç—å:**\n`;
  response += `‚Ä¢ üìÖ –ó–∞ 30 –¥–Ω–µ–π –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è\n`;
  response += `‚Ä¢ üéØ –í –¥–∞—Ç—É –≤—ã–¥–∞—á–∏ –∫—Ä–µ–¥–∏—Ç–∞\n\n`;

  response += `**–ß—Ç–æ –ø–æ—Ç—Ä–µ–±—É–µ—Ç—Å—è:**\n`;
  response += `‚Ä¢ üìù –ó–∞—è–≤–ª–µ–Ω–∏–µ –Ω–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏–µ\n`;
  response += `‚Ä¢ ‚úÖ –ê–∫—Ç —Å–≤–µ—Ä–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π\n`;
  response += `‚Ä¢ üè• –ú–µ–¥–∏—Ü–∏–Ω—Å–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã (–ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏)\n\n`;

  response += `**–ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –ø—Ä–æ–¥–ª–µ–Ω–∏—è:**\n`;
  response += `‚Ä¢ üéÅ –°–∫–∏–¥–∫–∏ –∑–∞ –±–µ–∑—É–±—ã—Ç–æ—á–Ω–æ—Å—Ç—å\n`;
  response += `‚Ä¢ ‚ö° –ë–µ–∑ –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –º–µ–¥–æ—Å–º–æ—Ç—Ä–∞\n`;
  response += `‚Ä¢ üí∞ –ë–æ–ª–µ–µ –≤—ã–≥–æ–¥–Ω—ã–µ —É—Å–ª–æ–≤–∏—è\n\n`;

  response += `**–°—Ç–æ–∏–º–æ—Å—Ç—å:**\n`;
  response += `‚Ä¢ –û–±—ã—á–Ω–æ —Ç–∞–∫–∞—è –∂–µ, –∫–∞–∫ –≤ –ø—Ä–æ—à–ª–æ–º –≥–æ–¥—É\n`;
  response += `‚Ä¢ –ú–æ–∂–µ—Ç —É–º–µ–Ω—å—à–∏—Ç—å—Å—è –ø—Ä–∏ —Å–∫–∏–¥–∫–∞—Ö\n\n`;

  response += `üí° **–°–æ–≤–µ—Ç:** –ü—Ä–æ–¥–ª–µ–≤–∞–π—Ç–µ –∑–∞—Ä–∞–Ω–µ–µ, —á—Ç–æ–±—ã –∏–∑–±–µ–∂–∞—Ç—å –ø–µ—Ä–µ—Ä—ã–≤–∞ –≤ —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–∏!`;

  return response;
}

function generateLearningResponse() {
  return `üéì **–ö–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ–±—É—á–µ–Ω–∏–µ –ò–ò**\n\n` +
         `**–ú–æ–π –º–µ—Ö–∞–Ω–∏–∑–º –æ–±—É—á–µ–Ω–∏—è:**\n` +
         `‚Ä¢ üìö **–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π** - 50+ –∑–∞—Ä–∞–Ω–µ–µ –ø–æ–¥–≥–æ—Ç–æ–≤–ª–µ–Ω–Ω—ã—Ö —É–º–Ω—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤\n` +
         `‚Ä¢ üß† **–ê–Ω–∞–ª–∏–∑ –∑–∞–ø—Ä–æ—Å–æ–≤** - –ø–æ–Ω–∏–º–∞—é –Ω–∞–º–µ—Ä–µ–Ω–∏—è –∏ –∫–æ–Ω—Ç–µ–∫—Å—Ç\n` +
         `‚Ä¢ üíæ **–ü–∞–º—è—Ç—å –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤** - –∑–∞–ø–æ–º–∏–Ω–∞—é —É—Å–ø–µ—à–Ω—ã–µ –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏—è\n` +
         `‚Ä¢ üìà **–°–∞–º–æ—É–ª—É—á—à–µ–Ω–∏–µ** - –∞–¥–∞–ø—Ç–∏—Ä—É—é—Å—å –ø–æ–¥ —á–∞—Å—Ç—ã–µ –≤–æ–ø—Ä–æ—Å—ã\n\n` +
         `**–ü—Ä–∏–º–µ—Ä—ã –æ–±—É—á–µ–Ω–∏—è:**\n` +
         `‚Ä¢ –ü–µ—Ä–≤—ã–π —Ä–∞–∑: "–ß—Ç–æ –¥–µ–ª–∞—Ç—å –ø—Ä–∏ –ø–æ–∂–∞—Ä–µ?" ‚Üí —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω—ã–π –æ—Ç–≤–µ—Ç\n` +
         `‚Ä¢ –ü–æ—Å–ª–µ –æ–±—É—á–µ–Ω–∏—è: –ø–µ—Ä—Å–æ–Ω–∞–ª–∏–∑–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Å–æ–≤–µ—Ç—ã\n\n` +
         `**–†–µ–∑—É–ª—å—Ç–∞—Ç:** –ö–∞–∂–¥—ã–π —Ä–∞–∑–≥–æ–≤–æ—Ä –¥–µ–ª–∞–µ—Ç –º–µ–Ω—è —É–º–Ω–µ–µ! üöÄ`;
}

function generateAboutResponse() {
  return `ü§ñ **–û —Å–µ–±–µ - –ú–æ—â–Ω—ã–π –û–±—É—á–∞–µ–º—ã–π –ü–∞—Ä—Å–µ—Ä**\n\n` +
         `**–ú–æ–∏ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏:**\n` +
         `‚Ä¢ üî¢ –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ —Ä–∞—Å—á–µ—Ç—ã –∏–∑ —Ç–µ–∫—Å—Ç–∞\n` +
         `‚Ä¢ üí¨ –ï—Å—Ç–µ—Å—Ç–≤–µ–Ω–Ω—ã–π –¥–∏–∞–ª–æ–≥ –Ω–∞ —Ä—É—Å—Å–∫–æ–º\n` +
         `‚Ä¢ üìä –ê–Ω–∞–ª–∏–∑ –∏ —Å—Ä–∞–≤–Ω–µ–Ω–∏–µ –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–π\n` +
         `‚Ä¢ üí° –ü–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã–µ —Å–æ–≤–µ—Ç—ã\n` +
         `‚Ä¢ üö® –ü–æ–º–æ—â—å –≤ —á—Ä–µ–∑–≤—ã—á–∞–π–Ω—ã—Ö —Å–∏—Ç—É–∞—Ü–∏—è—Ö\n` +
         `‚Ä¢ üéì –û–±—É—á–µ–Ω–∏–µ –Ω–∞ –∫–∞–∂–¥–æ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏\n\n` +
         `**–ë–∞–∑–∞ –∑–Ω–∞–Ω–∏–π:** 50+ —Å—Ü–µ–Ω–∞—Ä–∏–µ–≤ —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏—è\n` +
         `**–¢–æ—á–Ω–æ—Å—Ç—å:** –ü–æ—Å—Ç–æ—è–Ω–Ω–æ–µ —É–ª—É—á—à–µ–Ω–∏–µ –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤\n` +
         `**–°–∫–æ—Ä–æ—Å—Ç—å:** –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–µ –æ—Ç–≤–µ—Ç—ã –±–µ–∑ –∑–∞–¥–µ—Ä–∂–µ–∫\n\n` +
         `–Ø –∑–¥–µ—Å—å, —á—Ç–æ–±—ã —Å–¥–µ–ª–∞—Ç—å –∏–ø–æ—Ç–µ—á–Ω–æ–µ —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ –ø—Ä–æ—Å—Ç—ã–º –∏ –ø–æ–Ω—è—Ç–Ω—ã–º! üè†‚ú®`;
}

function generateGeneralResponse(analysis) {
  let response = `üè† **–ò–ø–æ—Ç–µ—á–Ω–æ–µ —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏–µ - –≤–∞—à –Ω–∞–¥–µ–∂–Ω—ã–π —â–∏—Ç**\n\n`;

  response += `**–ü–æ—á–µ–º—É –æ–Ω–æ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ:**\n`;
  response += `‚Ä¢ üèõÔ∏è –¢—Ä–µ–±–æ–≤–∞–Ω–∏–µ –¶–ë –†–§\n`;
  response += `‚Ä¢ üõ°Ô∏è –ó–∞—â–∏—Ç–∞ –æ—Ç —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Ä–∏—Å–∫–æ–≤\n`;
  response += `‚Ä¢ üíº –£—Å–ª–æ–≤–∏–µ –ø–æ–ª—É—á–µ–Ω–∏—è –∫—Ä–µ–¥–∏—Ç–∞\n\n`;

  response += `**–ß—Ç–æ –∑–∞—â–∏—â–∞–µ—Ç:**\n`;
  response += `‚Ä¢ üë§ –ñ–∏–∑–Ω—å –∏ –∑–¥–æ—Ä–æ–≤—å–µ (–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)\n`;
  response += `‚Ä¢ üè° –ù–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç—å (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)\n`;
  response += `‚Ä¢ üìã –ü—Ä–∞–≤–æ —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–æ—Å—Ç–∏ (–¥–ª—è –≤—Ç–æ—Ä–∏—á–∫–∏)\n\n`;

  response += `**–°—Ç–æ–∏–º–æ—Å—Ç—å:** 0.5-3% –æ—Ç —Å—É–º–º—ã –∫—Ä–µ–¥–∏—Ç–∞ –µ–∂–µ–≥–æ–¥–Ω–æ\n\n`;

  if (analysis.complexity === 'simple') {
    response += `üí¨ **–ß–µ–º —è –º–æ–≥—É –ø–æ–º–æ—á—å?**\n`;
    response += `‚Ä¢ –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å\n`;
    response += `‚Ä¢ –ü–æ–¥–æ–±—Ä–∞—Ç—å –æ–ø—Ç–∏–º–∞–ª—å–Ω—ã–π –≤–∞—Ä–∏–∞–Ω—Ç\n`;
    response += `‚Ä¢ –û—Ç–≤–µ—Ç–∏—Ç—å –Ω–∞ –≤–æ–ø—Ä–æ—Å—ã\n\n`;
    response += `–ü–æ–ø—Ä–æ–±—É–π—Ç–µ: "–°–±–µ—Ä–±–∞–Ω–∫ –æ—Å–∑ 3000000 –º—É–∂ 15.08.1985 –∫–≤–∞—Ä—Ç–∏—Ä–∞"`;
  }

  return response;
}

function generateSmartFallback(question, analysis) {
  // –£–º–Ω—ã–π fallback —Å –ø—Ä–µ–¥–ª–æ–∂–µ–Ω–∏—è–º–∏
  const suggestions = [];

  if (analysis.intent === 'unknown') {
    suggestions.push('üìä –†–∞—Å—Å—á–∏—Ç–∞—Ç—å —Å—Ç–æ–∏–º–æ—Å—Ç—å —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏—è');
    suggestions.push('üìÑ –£–∑–Ω–∞—Ç—å –æ –Ω–µ–æ–±—Ö–æ–¥–∏–º—ã—Ö –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ö');
    suggestions.push('üí∞ –ü–æ–ª—É—á–∏—Ç—å –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–∫–∏–¥–∫–∞—Ö');
    suggestions.push('üéì –£–∑–Ω–∞—Ç—å –∫–∞–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ–±—É—á–µ–Ω–∏–µ –ò–ò');
    suggestions.push('ü§ñ –£–∑–Ω–∞—Ç—å –æ –º–æ–∏—Ö –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç—è—Ö');
  }

  let response = `ü§î **–Ø –ø–æ—Å—Ç–∞—Ä–∞–ª—Å—è –ø–æ–Ω—è—Ç—å –≤–∞—à –≤–æ–ø—Ä–æ—Å, –Ω–æ –Ω—É–∂–Ω–æ —É—Ç–æ—á–Ω–∏—Ç—å.**\n\n`;

  if (suggestions.length > 0) {
    response += `**–í–æ–∑–º–æ–∂–Ω–æ, –≤—ã –∏–º–µ–ª–∏ –≤ –≤–∏–¥—É:**\n`;
    suggestions.forEach(suggestion => {
      response += `‚Ä¢ ${suggestion}\n`;
    });
    response += `\n`;
  }

  response += `**–ü–æ–ø—Ä–æ–±—É–π—Ç–µ —Å–ø—Ä–æ—Å–∏—Ç—å:**\n`;
  response += `‚Ä¢ "–ö–∞–∫–∏–µ –¥–æ–∫—É–º–µ–Ω—Ç—ã –Ω—É–∂–Ω—ã –¥–ª—è –∏–ø–æ—Ç–µ–∫–∏?"\n`;
  response += `‚Ä¢ "–í —á–µ–º —Ä–∞–∑–Ω–∏—Ü–∞ –º–µ–∂–¥—É –≤–∏–¥–∞–º–∏ —Å—Ç—Ä–∞—Ö–æ–≤–∞–Ω–∏—è?"\n`;
  response += `‚Ä¢ "–°–±–µ—Ä–±–∞–Ω–∫ –æ—Å–∑ 3000000 –º—É–∂ 15.08.1985 –∫–≤–∞—Ä—Ç–∏—Ä–∞"\n`;
  response += `‚Ä¢ "–†–∞—Å—Å–∫–∞–∂–∏ –æ —Å–µ–±–µ"\n\n`;

  response += `–ò–ª–∏ –ø–µ—Ä–µ—Ñ–æ—Ä–º—É–ª–∏—Ä—É–π—Ç–µ –≤–æ–ø—Ä–æ—Å –±–æ–ª–µ–µ –ø–æ–¥—Ä–æ–±–Ω–æ! üòä`;

  return response;
}

// –≠–∫—Å–ø–æ—Ä—Ç–∏—Ä—É–µ–º —Ñ—É–Ω–∫—Ü–∏–∏ –≤ –≥–ª–æ–±–∞–ª—å–Ω—É—é –æ–±–ª–∞—Å—Ç—å
window.chatWithGrok = chatWithGrok;
window.askGPTNeo = askGPTNeo;
